# Mermaid æ¸²æŸ“è§£å†³æ–¹æ¡ˆ

## é—®é¢˜æè¿°

ä¹‹å‰ä½¿ç”¨ mermaid.ink API æ¸²æŸ“ Mermaid å›¾è¡¨æ—¶ï¼Œé‡åˆ°äº†æœåŠ¡ä¸ç¨³å®šçš„é—®é¢˜ï¼ˆ404/503 é”™è¯¯ï¼‰ï¼Œå¯¼è‡´è‰ç¨¿ä¸­çš„æµç¨‹å›¾æ— æ³•æ­£å¸¸æ˜¾ç¤ºã€‚

## è§£å†³æ–¹æ¡ˆæ¶æ„

ç°å·²å®ç°**ä¸‰å±‚é™çº§ç­–ç•¥**ï¼Œç¡®ä¿åœ¨å„ç§ç¯å¢ƒä¸‹éƒ½èƒ½ä¼˜é›…å¤„ç† Mermaid å›¾è¡¨ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ä¸€å±‚: Playwright æœ¬åœ°æµè§ˆå™¨æ¸²æŸ“     â”‚  â† ä¼˜å…ˆä½¿ç”¨ï¼ˆæœ€ç¨³å®šï¼‰
â”‚  - å®Œå…¨æœ¬åœ°åŒ–ï¼Œä¸ä¾èµ–å¤–éƒ¨æœåŠ¡          â”‚
â”‚  - æ¸²æŸ“è´¨é‡é«˜ï¼Œç¬¦åˆå®˜æ–¹æ ‡å‡†            â”‚
â”‚  - éœ€è¦å®‰è£… playwright åŒ…              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ å¤±è´¥ â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬äºŒå±‚: Kroki.io API è¿œç¨‹æ¸²æŸ“         â”‚  â† å¤‡ç”¨æ–¹æ¡ˆ
â”‚  - æ¯” mermaid.ink æ›´ç¨³å®š               â”‚
â”‚  - æ— éœ€æœ¬åœ°ä¾èµ–                        â”‚
â”‚  - éœ€è¦ç½‘ç»œè¿æ¥                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ å¤±è´¥ â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ä¸‰å±‚: ä¼˜é›…é™çº§ä¸ºæ ¼å¼åŒ–ä»£ç å—        â”‚  â† å…œåº•æ–¹æ¡ˆ
â”‚  - æ˜¾ç¤ºåŸå§‹ Mermaid ä»£ç                â”‚
â”‚  - å¸¦æœ‰å‹å¥½çš„æ ·å¼å’Œæç¤º                â”‚
â”‚  - ä¿è¯å†…å®¹ä¸ä¸¢å¤±                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æŠ€æœ¯å®ç°

### æ ¸å¿ƒå‡½æ•°

#### 1. `render_mermaid_with_playwright(mermaid_code)`

ä½¿ç”¨ Playwright åœ¨æ— å¤´æµè§ˆå™¨ä¸­æ¸²æŸ“ Mermaid å›¾è¡¨ã€‚

**å·¥ä½œæµç¨‹**:
1. åˆ›å»ºä¸´æ—¶ HTML æ–‡ä»¶ï¼ŒåŠ è½½ mermaid.js CDN
2. ä½¿ç”¨ Playwright å¯åŠ¨ Chromium æ— å¤´æµè§ˆå™¨
3. ç­‰å¾…å›¾è¡¨æ¸²æŸ“å®Œæˆï¼ˆ2ç§’ï¼‰
4. æˆªå– SVG å…ƒç´ çš„æˆªå›¾
5. è¿”å› PNG å›¾ç‰‡è·¯å¾„

**ä¼˜ç‚¹**:
- âœ… å®Œå…¨æœ¬åœ°åŒ–ï¼Œä¸å—å¤–éƒ¨æœåŠ¡å½±å“
- âœ… æ¸²æŸ“è´¨é‡é«˜
- âœ… æ”¯æŒæ‰€æœ‰ Mermaid å›¾è¡¨ç±»å‹

**è¦æ±‚**:
```bash
pip install playwright
playwright install chromium
```

#### 2. `render_mermaid_with_kroki(mermaid_code)`

ä½¿ç”¨ Kroki.io API è¿œç¨‹æ¸²æŸ“ã€‚

**ç¼–ç æ–¹å¼**:
```python
compressed = zlib.compress(mermaid_code.encode('utf-8'), level=9)
encoded = base64.urlsafe_b64encode(compressed).decode('utf-8')
url = f"https://kroki.io/mermaid/png/{encoded}"
```

**ä¼˜ç‚¹**:
- âœ… æ— éœ€æœ¬åœ°ä¾èµ–
- âœ… æ¯” mermaid.ink æ›´ç¨³å®š
- âœ… å®˜æ–¹ç»´æŠ¤

#### 3. `render_mermaid_locally(mermaid_code)`

åè°ƒä¸‰å±‚é™çº§ç­–ç•¥çš„ä¸»æ§å‡½æ•°ã€‚

**é™çº§é€»è¾‘**:
```python
# å°è¯•ç¬¬ä¸€å±‚
result = render_mermaid_with_playwright(code)
if result: return result

# å°è¯•ç¬¬äºŒå±‚
result = render_mermaid_with_kroki(code)
if result: return result

# ç¬¬ä¸‰å±‚é™çº§
return None  # è§¦å‘ä»£ç å—æ˜¾ç¤º
```

### é™çº§ä»£ç å—æ ·å¼

å½“æ‰€æœ‰æ¸²æŸ“æ–¹æ¡ˆå¤±è´¥æ—¶ï¼Œä¼šç”Ÿæˆå¦‚ä¸‹ HTMLï¼š

```html
<section class="mermaid-fallback" style="...">
  <p>ğŸ“Š æµç¨‹å›¾ (Mermaid)</p>
  <pre><code>{åŸå§‹ä»£ç }</code></pre>
  <p>æç¤º: å›¾è¡¨æ¸²æŸ“æš‚æ—¶ä¸å¯ç”¨ï¼Œå·²æ˜¾ç¤ºåŸå§‹ä»£ç </p>
</section>
```

## å®‰è£…ä¸é…ç½®

### 1. å®‰è£…ä¾èµ–ï¼ˆæ¨èï¼‰

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd obsidian-wechat

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate  # macOS/Linux
# æˆ–
.venv\\Scripts\\activate    # Windows

# å®‰è£… Playwright
pip install playwright

# ä¸‹è½½ Chromium æµè§ˆå™¨
playwright install chromium
```

### 2. ä»…ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼ˆæ— éœ€é¢å¤–ä¾èµ–ï¼‰

å¦‚æœä¸å®‰è£… Playwrightï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è·³è½¬åˆ° Kroki.io APIï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

## æµ‹è¯•éªŒè¯

### è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
.venv/bin/python test_mermaid.py
```

### é¢„æœŸè¾“å‡º

```
============================================================
Mermaid æ¸²æŸ“æµ‹è¯•
============================================================

å¤„ç† Mermaid å›¾è¡¨...
  [1/3] å°è¯•ä½¿ç”¨ Playwright æœ¬åœ°æ¸²æŸ“...
  âœ“ Playwright æ¸²æŸ“æˆåŠŸ

å¤„ç† Mermaid å›¾è¡¨...
  [1/3] å°è¯•ä½¿ç”¨ Playwright æœ¬åœ°æ¸²æŸ“...
  âœ“ Playwright æ¸²æŸ“æˆåŠŸ

âœ… æµ‹è¯•é€šè¿‡: Mermaid ä»£ç å—å·²è¢«å¤„ç†
```

## ä½¿ç”¨ç¤ºä¾‹

### Markdown æ–‡ä»¶ç¤ºä¾‹

```markdown
---
title: "æŠ€æœ¯æ–¹æ¡ˆ"
---

# ç³»ç»Ÿæ¶æ„

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚] --> B{é‰´æƒ}
    B -->|æˆåŠŸ| C[ä¸šåŠ¡å¤„ç†]
    B -->|å¤±è´¥| D[è¿”å›é”™è¯¯]
    C --> E[è¿”å›ç»“æœ]
```

## æ—¶åºå›¾

```mermaid
sequenceDiagram
    Client->>Server: å‘é€è¯·æ±‚
    Server-->>Client: è¿”å›å“åº”
```
\```

### å‘å¸ƒåˆ°å¾®ä¿¡

```bash
# ä½¿ç”¨å‘å¸ƒè„šæœ¬
.venv/bin/python publish_to_wechat.py your_article.md

# æˆ–ä½¿ç”¨ä¾¿æ·è„šæœ¬
./publish.sh your_article.md
```

## æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | å¹³å‡è€—æ—¶ | ç¨³å®šæ€§ | ä¾èµ– |
|------|---------|--------|------|
| Playwright | ~3ç§’ | â­â­â­â­â­ | playwright |
| Kroki.io | ~1ç§’ | â­â­â­â­ | ç½‘ç»œ |
| é™çº§æ˜¾ç¤º | <0.1ç§’ | â­â­â­â­â­ | æ—  |

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: Playwright å®‰è£…å¤±è´¥

**ç—‡çŠ¶**: `ModuleNotFoundError: No module named 'playwright'`

**è§£å†³**:
```bash
pip install playwright
playwright install chromium
```

### é—®é¢˜ 2: Kroki.io è¶…æ—¶

**ç—‡çŠ¶**: `Kroki.io æ¸²æŸ“å¤±è´¥: timeout`

**è§£å†³**:
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- ç³»ç»Ÿä¼šè‡ªåŠ¨é™çº§ä¸ºä»£ç å—æ˜¾ç¤º

### é—®é¢˜ 3: æ‰€æœ‰æ–¹æ¡ˆéƒ½å¤±è´¥

**ç—‡çŠ¶**: å›¾è¡¨æ˜¾ç¤ºä¸ºä»£ç å—

**è¯´æ˜**: è¿™æ˜¯æ­£å¸¸çš„é™çº§è¡Œä¸ºï¼Œç¡®ä¿å†…å®¹ä¸ä¸¢å¤±ã€‚å¯ä»¥ï¼š
1. æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•
2. æ‰‹åŠ¨å®‰è£… Playwright
3. æ¥å—ä»£ç å—æ˜¾ç¤ºï¼ˆå†…å®¹å®Œæ•´ä¿ç•™ï¼‰

## æŠ€æœ¯ç»†èŠ‚

### Kroki.io ç¼–ç ç®—æ³•

Kroki ä½¿ç”¨ deflate å‹ç¼© + Base64 URL-safe ç¼–ç ï¼š

```python
import zlib
import base64

# å‹ç¼©
compressed = zlib.compress(diagram_code.encode('utf-8'), level=9)

# ç¼–ç 
encoded = base64.urlsafe_b64encode(compressed).decode('utf-8')

# ç”Ÿæˆ URL
url = f"https://kroki.io/mermaid/png/{encoded}"
```

### Playwright æ¸²æŸ“ä¼˜åŒ–

- ä½¿ç”¨æ— å¤´æ¨¡å¼ï¼ˆheadless=Trueï¼‰èŠ‚çœèµ„æº
- è®¾ç½®åˆç†çš„è§†å£å¤§å°ï¼ˆ800x600ï¼‰
- ç­‰å¾…æ—¶é—´ä¼˜åŒ–ä¸º 2 ç§’ï¼ˆè¶³å¤Ÿæ¸²æŸ“å®Œæˆï¼‰
- ä»…æˆªå– SVG å…ƒç´ ï¼Œé¿å…å¤šä½™ç©ºç™½

## æ›´æ–°æ—¥å¿—

### 2026-01-24

- âœ… å®ç° Playwright æœ¬åœ°æ¸²æŸ“
- âœ… æ·»åŠ  Kroki.io å¤‡ç”¨æ–¹æ¡ˆ
- âœ… å®Œå–„é™çº§ä»£ç å—æ ·å¼
- âœ… æ·»åŠ å®Œæ•´æµ‹è¯•è„šæœ¬
- âœ… æ›´æ–°æ–‡æ¡£

## å‚è€ƒèµ„æº

- [Playwright å®˜æ–¹æ–‡æ¡£](https://playwright.dev/python/)
- [Kroki.io å®˜æ–¹æ–‡æ¡£](https://kroki.io/)
- [Mermaid è¯­æ³•å‚è€ƒ](https://mermaid.js.org/)
- [é¡¹ç›® GitHub](https://github.com/anthropics/claude-code)

---

**ç»´æŠ¤è€…**: Chaucer
**æœ€åæ›´æ–°**: 2026-01-24
